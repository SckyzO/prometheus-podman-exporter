name: Sync and Build Factory

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    outputs:
      new_tag: ${{ steps.check_tag.outputs.new_tag }}
      tag_name: ${{ steps.check_tag.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "Build Factory Bot"
          git config user.email "bot@buildfactory.local"

      - name: Check and Sync Upstream Tags
        id: check_tag
        run: |
          git remote add upstream https://github.com/containers/prometheus-podman-exporter.git
          git fetch upstream --tags --force

          LATEST_UPSTREAM=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          
          # Always export the tag name so the build job knows what to checkout
          echo "tag_name=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT

          if git rev-parse "$LATEST_UPSTREAM" >/dev/null 2>&1; then
            echo "Tag $LATEST_UPSTREAM already exists."
            echo "new_tag=false" >> $GITHUB_OUTPUT
          else
            echo "New tag found: $LATEST_UPSTREAM"
            echo "new_tag=true" >> $GITHUB_OUTPUT
            git tag "$LATEST_UPSTREAM" upstream/"$LATEST_UPSTREAM"
            git push origin "$LATEST_UPSTREAM"
          fi

  build-and-release:
    needs: sync-upstream
    if: |
      always() && 
      (
        github.event_name == 'push' || 
        needs.sync-upstream.outputs.new_tag == 'true' ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Save Config
        run: cp nfpm.yaml /tmp/nfpm.yaml

      - name: Checkout and Build Target
        run: |
          TAG_NAME="${{ needs.sync-upstream.outputs.tag_name }}"
          
          if [ -z "$TAG_NAME" ]; then
            echo "Error: No tag name provided."
            exit 1
          fi

          echo "Preparing to build tag: $TAG_NAME"
          
          # Add upstream to ensure we have the source of truth
          git remote add upstream https://github.com/containers/prometheus-podman-exporter.git || true
          
          # Fetch specifically the tag we want to build
          echo "Fetching tag $TAG_NAME from upstream..."
          git fetch upstream tag "$TAG_NAME" --force
          
          # Checkout the tag forcefully (overwriting current workflow file if it doesn't exist in tag)
          echo "Checking out $TAG_NAME..."
          git checkout -f "$TAG_NAME"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install nFPM
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Build, Package and Bundle
        run: |
          # Build static binaries for both architectures
          make binary-remote-amd64
          make binary-remote-arm64
          
          mkdir -p dist
          
          # Restore nFPM config
          cp /tmp/nfpm.yaml .
          
          # Extract version from tag (remove 'v' prefix)
          VERSION="${{ needs.sync-upstream.outputs.tag_name }}"
          VERSION="${VERSION#v}"
          export VERSION
          
          # --- AMD64 ---
          echo "Packaging AMD64..."
          cp bin/remote/prometheus-podman-exporter-amd64 podman_exporter
          
          # Tarball
          tar -czvf dist/podman_exporter-linux-amd64.tar.gz podman_exporter LICENSE
          
          # DEB/RPM
          export ARCH=amd64
          nfpm pkg --packager deb --target dist/
          nfpm pkg --packager rpm --target dist/

          # --- ARM64 ---
          echo "Packaging ARM64..."
          cp bin/remote/prometheus-podman-exporter-arm64 podman_exporter
          
          # Tarball
          tar -czvf dist/podman_exporter-linux-arm64.tar.gz podman_exporter LICENSE
          
          # DEB/RPM
          export ARCH=arm64
          nfpm pkg --packager deb --target dist/
          nfpm pkg --packager rpm --target dist/
          
          ls -l dist/

      - name: Fetch Upstream Release Notes
        id: upstream_notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ needs.sync-upstream.outputs.tag_name }}"
          echo "Fetching release notes for $TAG_NAME from upstream..."
          
          # Try to fetch upstream release notes
          # We use || true to prevent failure if upstream release doesn't exist yet
          gh release view "$TAG_NAME" \
            --repo containers/prometheus-podman-exporter \
            --json body \
            --jq .body > RELEASE_NOTES.md || echo "" > RELEASE_NOTES.md
          
          # If empty, add a default header
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "Automated build from upstream tag $TAG_NAME" > RELEASE_NOTES.md
          else
             # Prepend a header
             sed -i "1s/^/## Upstream Release Notes\n\n/" RELEASE_NOTES.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.rpm
            dist/*.deb
          make_latest: true
          tag_name: ${{ needs.sync-upstream.outputs.tag_name }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}