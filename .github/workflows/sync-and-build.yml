name: Sync and Build Factory

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    outputs:
      new_tag: ${{ steps.check_tag.outputs.new_tag }}
      tag_name: ${{ steps.check_tag.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "Build Factory Bot"
          git config user.email "bot@buildfactory.local"

      - name: Check and Sync Upstream Tags
        id: check_tag
        run: |
          git remote add upstream https://github.com/containers/prometheus-podman-exporter.git
          git fetch upstream --tags

          LATEST_UPSTREAM=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          
          # Always export the tag name so the build job knows what to checkout
          echo "tag_name=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT

          if git rev-parse "$LATEST_UPSTREAM" >/dev/null 2>&1; then
            echo "Tag $LATEST_UPSTREAM already exists."
            echo "new_tag=false" >> $GITHUB_OUTPUT
          else
            echo "New tag found: $LATEST_UPSTREAM"
            echo "new_tag=true" >> $GITHUB_OUTPUT
            git tag "$LATEST_UPSTREAM" upstream/"$LATEST_UPSTREAM"
            git push origin "$LATEST_UPSTREAM"
          fi

  build-and-release:
    needs: sync-upstream
    if: |
      always() && 
      (
        github.event_name == 'push' || 
        needs.sync-upstream.outputs.new_tag == 'true' ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout and Build Target
        run: |
          TAG_NAME="${{ needs.sync-upstream.outputs.tag_name }}"
          
          if [ -z "$TAG_NAME" ]; then
            echo "Error: No tag name provided."
            exit 1
          fi

          echo "Preparing to build tag: $TAG_NAME"
          
          # Add upstream to ensure we have the source of truth
          git remote add upstream https://github.com/containers/prometheus-podman-exporter.git || true
          
          # Fetch specifically the tag we want to build
          echo "Fetching tag $TAG_NAME from upstream..."
          git fetch upstream tag "$TAG_NAME"
          
          # Checkout the tag forcefully (overwriting current workflow file if it doesn't exist in tag)
          echo "Checking out $TAG_NAME..."
          git checkout -f "$TAG_NAME"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.7'

      - name: Build and Package Binaries
        run: |
          # Build static binaries for both architectures
          make binary-remote-amd64
          make binary-remote-arm64
          
          mkdir -p dist
          
          # Package AMD64
          cp bin/remote/prometheus-podman-exporter-amd64 podman_exporter
          tar -czvf dist/podman_exporter-linux-amd64.tar.gz podman_exporter LICENSE
          
          # Package ARM64
          cp bin/remote/prometheus-podman-exporter-arm64 podman_exporter
          tar -czvf dist/podman_exporter-linux-arm64.tar.gz podman_exporter LICENSE

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.tar.gz
          make_latest: true
          tag_name: ${{ needs.sync-upstream.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}